# Script Weaver - TODO List

## 🎯 MVP 목표

웹 기반 Dialogue Editor (프론트엔드-Only) - 컨텐츠-키 분리 아키텍처 기반

> **핵심**: 기획자는 실제 텍스트만 입력, 로컬라이징 키는 백그라운드 자동 관리

---

## ✅ 완료된 작업

### Phase 1 기본 시스템 구축 + 컨텐츠-키 분리 아키텍처 ✅

-   React + Vite + TypeScript, Tailwind CSS 4.x, React Flow, Zustand 기반 웹 에디터 구축
-   노드 생성/편집/연결 시스템, 텍스트-키 분리 아키텍처, 자동 키 생성, JSON/CSV 데이터 관리

### Phase 2 사용성 개선 ✅

-   **UX-01 중복 텍스트 처리**: 모달 → 토스트 메시지, 전역 관리
-   **노드 배치 개선**: Y축 세로 → X축 가로 배치, 성능 최적화 (100개 노드 제한)
-   **자동 정렬 기능**: 선택된 노드 기준 자식 정렬, 전체 트리 정렬 기능
-   **레이아웃 엔진 시스템**: 3단계 파이프라인, 앵커 오프셋, 순환 참조 감지 (dagre 기반)
-   **전역 단축키 시스템**: 전문 편집 도구 수준의 키보드 워크플로우
-   **UI 간소화**: 좌측 패널 70% 공간 절약, 핵심 기능 중심 재구성

---

## 📋 현재 상태

### 프로젝트 현황 🎉 **Phase 2 진행 중!**

-   ✅ **Phase 1 완료 100%**: 컨텐츠-키 분리 아키텍처 기반 MVP 완성
-   🟡 **Phase 2 진행 중**: 노드 배치 고도화 + 핵심 편집 기능 개선 진행 중
-   ✅ **LocalizationStore**: 키 자동 생성, 중복 감지, 일괄 수정, 전역 토스트 관리
-   ✅ **레이아웃 엔진 시스템**: 3단계 파이프라인 + 3가지 정렬 기능 완성

### 현재 배포 상태 📊 **(안정적 운영 중)**

-   ✅ **기능 완성도**: 87% - 모든 MVP + Phase 2 UX 개선 완료
-   ✅ **품질 안정성**: 99% - 모든 AC 항목, QA, 회귀 테스트 검증
-   ✅ **사용자 경험**: 96% - 전문 도구 수준 달성 🎉
-   ✅ **성능 최적화**: 94% - 100개 노드 제한, 즉시 배치, 순환 참조 방어
-   ✅ **GitHub Pages 배포**: 안정적 운영 중 🌟
-   🎯 **다음 단계**: Phase 2 완성 - 핵심 편집 기능 개선

---

## 📋 예정된 작업

### **Phase 2: 사용성 개선** 🟡 **진행 중 (85% 완료)**

#### 완료된 핵심 개선사항 ✅

-   [x] UX-01 중복 텍스트 처리 개선, 노드 배치 기본 개선, 자동 정렬 기능
-   [x] 성능 최적화, 전역 단축키 시스템, UI 간소화
-   [x] **핸들 클릭 노드 생성 위치 개선** - 부모 노드 우측 50px 간격, 중앙 정렬
-   [x] **레이아웃 엔진 시스템 구축** - `layoutEngine.ts` 완전한 레이아웃 시스템 (463줄)
-   [x] **다중 선택 및 조작** - Ctrl+Click, 드래그 선택, 일괄 삭제/이동
-   [x] **핸들 클릭으로 후속 노드 생성**, **화자 자동 입력 기능**
-   [x] **노드 생성 로직 리팩터링** - 중복 코드 제거, 일관된 기본값 적용
-   [x] **선택지 노드 기본 구조 개선** - 생성 시 빈 선택지 2개 자동 제공
-   [x] **Undo/Redo 시스템 확장** - LocalizationStore 포함, 비동기 작업 관리자, 상태 충돌 방지
-   [x] **노드 복사/붙여넣기 고도화** - 다중 노드 복사 시 내부 연결 관계 유지
-   [x] **노드 삭제 시 키 정리** - 삭제된 노드의 LocalizationStore 키 자동 제거
-   [x] **skipHistory 매개변수 → 옵션 객체 패턴 개선** - 매개변수 확장성 확보
-   [x] **IEditorStore 인터페이스 정리** - 불필요한 선언 및 구현부 제거
-   [x] **키 정리 로직 중복 제거 및 공통화** - `src/utils/keyCleanup.ts` 분리

#### 노드 배치 및 정렬 시스템 개선 🎯 **높은 우선순위** 🟡 **진행 중**

-   [x] **다중 그래프 정렬 개선**: 독립적인 여러 그래프 존재 시 모든 그래프를 통합 정렬 ✅
    -   구현 완료: 다중 루트 발견 + 통합 레이아웃 - 모든 독립 그래프를 하나의 dagre 레이아웃으로 통합 처리
    -   성과: 기존 단일 그래프만 정렬 → 모든 독립 그래프 동시 정렬, 가상 루트 없이 직접 통합 수집 방식 적용
-   [x] **기존 정렬 시스템 정리**: 호환성 목적 기존 정렬 UI 및 로직 제거 ✅
    -   구현 완료: 점진적 제거 방식으로 안전하게 정리 (UI → editorStore → layoutDomain → types)
    -   성과: 코드 정리 + UI 간소화, "스마트 정렬 🚀" → "정렬"로 명칭 통일
    -   제거된 기능: arrangeChildNodesAsTree, arrangeAllNodesAsTree, arrangeNodesWithDagre
-   [ ] **레이아웃 엔진 개선 사항** - 테스트 중 발견된 추가 개선점들
    -   **다중 부모 노드 정렬**: DAG 구조에서 공통 자식을 가진 부모들의 연쇄 정렬 개선
        -   예시: 선택지 분기 후 합류하는 마무리 대사 노드의 정렬 최적화
    -   **노드 스냅 기능**: 드래그 시 근처 노드의 상하좌우 및 중앙에 자동 정렬 가이드
        -   구현: 항상 활성화, 실시간 스냅 가이드라인 표시

#### 핵심 편집 기능 개선 ⭐ **높은 우선순위**

-   [x] **노드 타입 변환 기능** - PropertyPanel에서 TextNode ↔ ChoiceNode 변환 **완료**
    -   **구현 완료**: PropertyPanel에 노드 타입 드롭다운 추가, 직접 변환 방식 구현
    -   **변환 로직 구현됨**: 
        - TextNode → ChoiceNode: `nextNodeKey`를 첫 번째 선택지로 이동, 기본 선택지 2개 자동 생성
        - ChoiceNode → TextNode: 첫 번째 선택지의 `nextNodeKey`를 노드로 이동
    -   **보존 정보**: `speakerText`, `contentText`, `speed`, 로컬라이제이션 키 참조 완벽 유지
    -   **구현 결과**: NodeDomain.convertNodeType() 메서드, 히스토리 연동, 성공 토스트 완료

#### 데이터 관리 및 기타 개선 🔧 **중요**

-   [ ] **localStorage 관리 도구** - 저장 공간 사용량 표시, 수동 정리 기능
-   [ ] **타입별 중복 검사 강화** - 화자/대사/선택지별 독립적 중복 감지

### Phase 3: 폴리싱 🟢 **선택적**

-   [ ] **시각적 개선**: 애니메이션 및 트랜지션 추가
    -   노드 생성/삭제 애니메이션
    -   연결 생성 시 시각적 피드백
    -   부드러운 트랜지션 효과
-   [ ] **성능 튜닝**: 빌드 최적화 및 번들 크기 최적화
    -   Vite 빌드 설정 최적화
    -   번들 크기 분석 및 최적화
    -   로딩 성능 개선

#### UI/UX 세부 개선 ✨ **사용자 경험**

-   [x] **삭제 확인 다이얼로그 제거** - Undo 기능으로 confirm 없이 즉시 삭제, 토스트 알림 추가 ✅
-   [x] **토스트 메시지 위치 변경** - 중앙 하단 → 중앙 상단으로 이동, 하단 상태창과 겹침 방지 ✅
-   [x] **노드 ID 미리보기 제거** - 기획자 친화적 UI로 ID 숨김 처리 ✅
-   [x] **노드 텍스트 줄바꿈 표시 개선** - 대화 내용/질문에서 줄바꿈 보존, 선택지는 한 줄 유지 ✅
-   [x] **엣지 제목 숨김** - 연결선 레이블 시각적 정리, 선택지 연결선 제목 제거 ✅
-   [ ] **노드 우클릭 메뉴** - 컨텍스트 메뉴로 빠른 액션 제공 (복사, 삭제, 타입 변환)
-   [ ] **모달 딤 조절 기능** - 배경 어둡기 사용자 설정
-   [ ] **장면 시작 노드 표시** - 시나리오 시작점 시각적 구분
-   [ ] **기본 접근성**: 키보드 탐색, 반응형 디자인
    -   Tab/Enter 키보드 탐색 지원
    -   모바일/태블릿 반응형 레이아웃
    -   ARIA 라벨 및 접근성 개선

#### 조건부 기능 확장 🔍 **검토 필요**

-   [ ] **InputDialogue 노드 지원** - 사용자 입력 노드 생성 및 런타임 속성
-   [ ] **선택지 전용 노드** - 대사 없이 선택지만 있는 노드 타입
-   [ ] **명시적 종료 노드** - 시나리오 종료점 명확화 (vs 현재 빈 nextNodeKey 방식)

---

## 🔮 향후 확장 계획 (Post-MVP)

### 우선순위 기능 (중요도 순)

1. **G-01: 로컬라이징 전용 탭** - key-value 매핑 직접 관리 (사용자 요청 높음)
2. **G-02: 플로우 시뮬레이터** - 플레이 모드 (기획자 검증 도구)
3. **G-06: InputDialogue 노드** - 사용자 입력 노드 생성 및 런타임 속성 지원 (기능 완성도)
4. **G-03: 콜백 키 CRUD 페이지** + 검색 (개발자 도구)

### 장기 계획

5. **G-04: 커스텀 메타데이터** - 감정, 카메라, SFX 확장 (확장성)
6. **G-05: 버전 관리** - Git, 다중 사용자 협업 (협업 도구)
7. **G-07: 히스토리 관리** - 작업 히스토리 diff 방식 기반으로 되돌리기/다시실행

-   장기 계획: 액션 기반 증분 저장으로 메모리 효율성 개선
-   전환 시점: 대용량 프로젝트 지원 시 (노드 1000개+) 또는 실시간 협업 기능 추가 시
-   기술적 고려사항: 현재 인터페이스 유지하여 호출부 코드 변경 없이 내부 구현만 교체 예정

### 레이아웃 엔진 로드맵 🗺️ **장기 계획**

1. **✅ ① 내부 MVP (Dagre)** - 3단계 해결 방식 + 3가지 정렬 기능 구현 **완료!**
2. **② 레이아웃 엔진 추상화** - 인터페이스 분리, 플러그인 아키텍처 구축 _(이미 구현됨)_
3. **③ 플러그인/웹워커화** - 백그라운드 처리, 성능 최적화
4. **④ ELK Pro 기능** - 복잡한 그래프, 고급 레이아웃 알고리즘
5. **⑤ 실시간 협업·권한 관리** - 다중 사용자 동시 편집
6. **⑥ 상품화 (Free/Pro 플랜)** - 기능별 티어링, 수익화 모델

---

## 📋 기술 정보 요약

### 아키텍처 핵심

-   **컨텐츠-키 분리**: 실제 텍스트(기획자) ↔ 로컬라이징 키(개발자) 완전 분리
-   **LocalizationStore**: 백그라운드 key-value 매핑 저장소
-   **의도적 키 관리**: 타이핑 중 키 생성 안함, 완료 시점에만 처리
-   **숫자 ID 기반 키**: `npc_1`, `line_1`, `choice_1` 형태로 충돌 방지

### 주요 제약사항 (MVP)

-   템플릿당 100개 노드 제한
-   TextDialogue, ChoiceDialogue만 생성 지원 (InputDialogue는 타입만)
-   서버 없는 SPA, localStorage만 사용
-   MVP에서는 순환 참조 허용 (루프 구조 지원)

### Acceptance Criteria 체크리스트 ✅ **QA 검증 완료**

-   [x] AC-01: 새 텍스트 노드 추가 → JSON 저장 및 키 매핑 ✅
-   [x] AC-02: 선택지별 "+" 버튼으로 해당 선택지의 nextNodeKey로 새 노드 자동 연결 ✅
-   [x] AC-03: nextNodeKey 비어있으면 Export 버튼 비활성화 및 검증 ✅
-   [x] AC-04: 브라우저 새로고침 후 Canvas 레이아웃 복원 ✅
-   [x] AC-05: JSON/CSV Export → Import 후 데이터 무손실 ✅
-   [x] AC-06: 같은 텍스트 입력 → 키 재사용 제안, 키 수정 → 일괄 변경 선택 ✅

---

## 📋 메모

### 개발 우선순위

1. ✅ **완료**: MVP + Phase 2 노드 배치 시스템 🎉
2. **현재**: Phase 2 완성 - 핵심 편집 기능 개선 🚀
3. **향후**: Phase 3 폴리싱 → Post-MVP 확장 기능

### 주요 레퍼런스

-   **PRD**: `document/prd.md` - 전체 프로젝트 사양 및 기술 스택
-   **기술 스택**: React + Vite + TypeScript, React Flow, Zustand, Tailwind CSS 4.x, Zod

### 임시 메모

-   "전체 캔버스 정렬"
    -   버튼 클릭 시, 루트 노드 하나에 대해서만 정렬되는 문제 있음
-   노드 생성 시 위치 기준 모호함
-   JSON 저장/불러오기 할 때 localizationStore 데이터 손실 문제 의심됨
-   undo/redo: 히스토리에 액션 명만 토스트 메세지로 띄워주면 될것 같음 (노드 아이디나 키 명칭은 표시하지 않음, 복합액션도 단순하게 표시)
-   콘솔 경고 에러메세지 코드화 필요
-   [ ] **노드 타입 모듈화**: TextDialogue/ChoiceDialogue 공통 부모 클래스/인터페이스 설계
    -   BaseDialogueNode 추상화로 확장성 확보 (InputDialogue, 커스텀 노드 대비)
    -   노드 생성/검증/직렬화 로직 통합, 타입 안전성 향상
    -   노드 컴포넌트는 시각적 요소만 남기고 논리적 코드는 외부로 이동
    -   inputDialogue 추가
    -   조건확인(if, switch) 노드 추가,
    -   씬 시작 블럭 추가 (데이터 구조 수정 필요함, 큰 작업)
-   [ ] **노드 변환 로직 범용화**: 하드코딩된 타입별 변환을 전략 패턴으로 리팩토링
    -   현재: `if (targetType === "choice")` 하드코딩 방식
    -   개선: BaseDialogue 공통 속성 기반 변환 전략 패턴 적용
    -   각 노드 타입별 변환 규칙을 독립적 전략으로 분리
    -   InputDialogue 등 추가 타입 확장 시 용이하도록 설계
-   큰 컴포넌트 분리
    -   [ ] **PropertyPanel.tsx 분리**: UI 컴포넌트 과부하 해결
    -   [ ] **App.tsx 분리**: 루트 컴포넌트 책임 분리
    -   [ ] **노드 생성 로직 통합**: 중복된 생성 함수들 팩토리 패턴으로 통합
    -   [ ] **유틸리티 함수 모듈 분리**: 분산된 헬퍼 함수들 적절한 모듈로 이동
-   세부 최적화
    -   [ ] **Canvas.tsx 분리**: 캔버스 로직 세분화
    -   [ ] **타입 정의 정리**: 중복/미사용 타입 정리
    -   [ ] **상수 정의 중앙화**: 매직 넘버/문자열 constants 파일로 이동
    -   [ ] **에러 메시지 코드화**: 콘솔 경고/에러 메시지 표준화
