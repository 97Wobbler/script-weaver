# Script Weaver - TODO List

## 🎯 MVP 목표
웹 기반 Dialogue Editor (프론트엔드-Only) - Twine 느낌의 시각 편집 + 우측 폼 패널

---

## ✅ 완료된 작업

### 1-2주차: 기본 시스템 구축 ✅ **완료!**
- [x] **프로젝트 환경 설정**: React + Vite + TypeScript, Tailwind CSS 4.x, React Flow, Zustand
- [x] **데이터 모델**: Dialogue 타입, Zod 스키마, EditorStore 상태 관리
- [x] **기본 UI**: 에디터 레이아웃, Canvas, 툴바, 속성 패널, 상태바
- [x] **노드 시스템**: TextNode/ChoiceNode 생성, 편집, 위치 저장, localStorage 지속성
- [x] **속성 패널**: 실시간 편집, 선택지 관리, 노드 선택 연동
- [x] **연결 시스템**: React Flow Handle 기반 드래그 연결, 핸들 위치 정렬, 연결 해제

### 3주차: Import/Export 및 검증 시스템 ✅ **완료!**
- [x] **Export 기능**
  - [x] JSON 형식 내보내기
  - [x] CSV 형식 내보내기 (dialogue.csv + localization.csv)
  - [x] 사용자 포맷 선택 UI
- [x] **Import 기능**
  - [x] JSON 파일 업로드 및 파싱 (유연한 스키마 적용)
  - [x] CSV 파일 업로드 및 파싱 (기본 구조, 낮은 우선순위)
- [x] **검증 시스템 (Zod)**
  - [x] 스키마 정의 및 검증
  - [x] Export 시점 검증으로 UX 통합
  - [x] 댕글링 참조 감지 및 자동 정리
  - [x] 빈 프로젝트 상태 적절한 처리
- [x] **localStorage 자동 저장**
  - [x] Zustand persist 자동 저장
  - [x] 브라우저 새로고침 시 복원

### 4주차: 컨텐츠-키 분리 아키텍처 🎯 **완료!**
- [x] **데이터 모델 확장**
  - [x] LocalizationStore 구현 (key-value 매핑 저장소) ✅ **완료!**
  - [x] BaseDialogue 구조 변경: 실제 텍스트(speakerText, contentText) + 키 참조(speakerKeyRef, textKeyRef) ✅ **완료!**
  - [x] 기존 데이터 마이그레이션 로직 ✅ **완료!**
- [x] **실제 텍스트 기반 UI**
  - [x] PropertyPanel: 화자/대사 입력은 실제 텍스트만 ✅ **완료!**
  - [x] 입력 필드 아래 자동생성된 키값 작게 표시 ✅ **완료!**
  - [x] 노드 미리보기: 실제 텍스트 표시 (키값 숨김) ✅ **완료!**
- [x] **키 자동 생성 시스템**
  - [x] speakerKey: `npc_{normalized_name}` 형식 ✅ **완료!**
  - [x] textKey: `{templateKey}_{sceneKey}_line_{shortId}` 형식 ✅ **완료!**
  - [x] choiceKey: `{templateKey}_{sceneKey}_choice_{shortId}_{index}` 형식 ✅ **완료!**
  - [x] 중복 텍스트 감지 및 기존 키 재사용 제안 ✅ **완료!**
- [x] **키 두 단계 편집 시스템**
  - [x] 키 클릭 → 편집 모드 UI ✅ **완료!**
  - [x] "모든 텍스트 함께 변경" vs "새 키로 분리" 선택 옵션 ✅ **완료!**
  - [x] 같은 키 사용 현황 표시 (사용하는 노드 개수 등) ✅ **완료!**
- [x] **일괄 수정 기능**
  - [x] 같은 textKey를 가진 모든 텍스트 동시 수정 ✅ **완료!**
  - [x] 키 변경시 연결된 모든 노드 업데이트 ✅ **완료!**
- [x] **Export/Import 업데이트**
  - [x] 새로운 데이터 구조에 맞춘 JSON/CSV 형식 수정 ✅ **완료!**
  - [x] LocalizationStore 포함한 파일 구조 ✅ **완료!**

### QA 후 버그 수정 ✅ **완료!**
- [x] **QA-BUG-01: 중복 텍스트 감지 로직 문제** - 중복 체크 우선 실행으로 수정
- [x] **QA-BUG-02: 노드 생성 시 기본값 문제** - 빈 문자열로 노드 생성하도록 수정
- [x] **QA-BUG-03: 키 편집 후 UI 동기화 문제** - PropertyPanel 리렌더링 트리거 추가
- [x] **QA-BUG-04: 키 편집 모달 텍스트 변경 반영 실패** - 노드 실제 텍스트 동기화 로직 추가
- [x] **QA-BUG-05: 키 편집 모달 버튼 표시 로직 개선** - 항상 버튼 표시, 변경사항 없으면 비활성화

### 4주차 QA 및 버그 수정 ✅ **완료!**
- [x] **TC-01 문제 해결**: 노드 생성 시 기본값 제거 (빈 문자열로 변경)
- [x] **TC-02 문제 해결**: 한국어 입력 시 글자 반복 현상 - IME 이벤트 처리 추가
- [x] **TC-04 문제 해결**: 키 편집 시 새 키 생성 → 기존 키 업데이트로 변경
- [x] **TC-04 문제 해결**: UI 동기화 - 키 참조 업데이트 시 실제 텍스트도 동기화
- [x] **TC-05 문제 해결**: 선택지 삭제 시 LocalizationStore에서 키 정리 추가

### 4주차 후반: 키 편집 UI 개선 ✅ **완료!**
- [x] **Phase 1: 키 편집 UI 단순화**
  - [x] "새 키로 분리" 버튼 제거
  - [x] 항상 "모든 위치 함께 변경"만 제공
  - [x] 단일/다중 사용 키 동일한 로직으로 처리
- [x] **Phase 2: 속성 패널 스마트 텍스트 관리**
  - [x] 단일 사용 키: 텍스트 변경 시 키 유지 (기존 키의 텍스트만 업데이트)
  - [x] 중복 텍스트 감지하여 기존 키 재사용 로직 구현
  - [x] 다중 사용 키: 새 키 생성 또는 기존 키 재사용
- [x] **Phase 3: 사용자 확인 UI**
  - [x] 중복 텍스트 발견 시 사용자 선택 모달
  - [x] "기존 키 사용" vs "새 키 생성" 옵션 제공
  - [x] 명확한 피드백 및 안내 메시지

### QA 재테스트 후 추가 버그 수정 ✅ **완료!**
- [x] **QA-BUG-06: 키 삭제 로직 문제** - 단일 사용 키만 삭제하도록 수정
- [x] **QA-BUG-07: 선택지 생성 시 빈 키 자동 배정** - 빈 텍스트일 때 키 생성 안함으로 수정
- [x] **QA-BUG-08: 중복 텍스트 모달 후 UI 동기화 문제** - 모달 처리 후 selectedNode 재설정 추가
- [x] **QA-BUG-09: 키 편집에서 텍스트 입력 제한 미적용** - 화자/선택지 줄 바꿈 금지 로직 추가

---

## 📋 현재 진행 중인 작업

### UX/UI 개선 제안 💡 **검토 대기**

#### **UX-01: 중복 텍스트 모달 단순화 제안**
- **제안 내용**: 중복 텍스트 발견 시 모달 대신 토스트 메시지로 간단히 알림
- **현재 상태**: "기존 키 사용" vs "새 키 생성" 선택 모달
- **개선 방향**: "기존에 이미 키가 있어서 자동으로 기존 키 배정" 토스트만 표시
- **장점**: 사용자 인터랙션 감소, 더 직관적인 UX
- **검토 필요**: 기능 제거 전 사용자 피드백 수집

### 5주차: 폴리싱 & QA 🎯 **준비 완료!**
- [ ] **최종 QA 재검증**
  - [ ] TC-P1-01~TC-P3-02 전체 재테스트
  - [ ] 수정된 버그들 정상 동작 확인 (QA-BUG-06~09)
  - [ ] 새로운 회귀 버그 체크
- [ ] **UI/UX 개선**
  - [ ] 반응형 디자인
  - [ ] 키보드 접근성  
  - [ ] 애니메이션 및 트랜지션
- [ ] **성능 최적화**
  - [ ] 100개 노드 제한 구현
  - [ ] 렌더링 최적화
- [ ] **배포 준비**
  - [ ] GitHub Pages 설정
  - [ ] 빌드 최적화

---

## 📋 예정된 작업

### 5주차: 폴리싱 & QA
- [ ] **UI/UX 개선**
  - [ ] 반응형 디자인
  - [ ] 키보드 접근성
  - [ ] 애니메이션 및 트랜지션
- [ ] **성능 최적화**
  - [ ] 100개 노드 제한 구현
  - [ ] 렌더링 최적화
- [ ] **최종 QA 및 테스트**
  - [ ] TC-01~TC-10 전체 재검증
  - [ ] 브라우저 호환성 테스트
- [ ] **배포 준비**
  - [ ] GitHub Pages 설정
  - [ ] 빌드 최적화

---

## 🔮 향후 확장 계획 (Post-MVP)

### 성능 최적화 및 아키텍처 개선

#### **P-01: 텍스트 입력 성능 최적화** ✅ **해결!**
- **문제**: textarea onChange 시마다 키 생성/검증 로직 실행으로 인한 성능 저하
- **해결 방안**: ✅ **완료 - 의도적 키 관리 시스템 구현**
  1. ✅ **로컬 상태 분리**: 입력 중에는 로컬 상태만 업데이트, blur/enter 시 실제 저장
  2. ✅ **IME 이벤트 처리**: 한국어 입력 중 키 생성 방지 및 글자 반복 해결
  3. ✅ **키 검색 최적화**: Map 구조 사용하여 O(1) 검색
- **우선순위**: ✅ **해결됨**

#### **P-02: 키 생성 방식 개선** ✅ **해결!**
- **문제**: 텍스트 기반 키 생성의 충돌 가능성 및 다국어 처리 복잡성
- **해결 방안**: ✅ **완료 - 숫자 ID 기반 키 시스템 구현**
  1. ✅ **숫자 ID 기반 키**: npc_1, line_1, choice_1 형태로 변경
  2. ✅ **중복 텍스트 감지**: 동일 텍스트 시 기존 키 재사용
  3. ✅ **순차 번호 관리**: 각 타입별 마지막 ID 추적하여 자동 증가
  4. ✅ **기존 데이터**: 리셋 후 새 방식 적용 (마이그레이션 생략)
- **우선순위**: ✅ **해결됨**

#### **P-03: 키 편집 UI 복잡성** ✅ **해결!**
- **문제**: "새 키로 분리" vs "모든 위치 함께 변경" 선택이 복잡하고 불필요한 경우 많음
- **해결 방안**: ✅ **완료 - 워크플로우 단순화**
  1. ✅ **키 편집 UI 단순화**: 항상 "모든 위치 함께 변경"만 제공
  2. ✅ **속성 패널 스마트 처리**: 단일 사용 키는 텍스트만 업데이트, 다중 사용 키는 새 키 생성
  3. ✅ **중복 텍스트 확인 UI**: 기존 키 재사용 여부를 사용자가 선택
- **우선순위**: ✅ **해결됨**

### 기능 확장

### G-01: 한글 원문·key 동시 입력/수정용 로컬라이징 전용 탭 (우선순위 상승)
### G-02: 플로우 시뮬레이터 (플레이 모드)
### G-03: 콜백 키 CRUD 페이지 + 검색
### G-04: 커스텀 메타데이터(감정, 카메라, SFX) 확장
### G-05: 버전 관리(Git)·다중 사용자 협업
### G-06: InputDialogue 노드 생성 및 런타임 속성 지원
### G-07: 순환 참조 감지 및 경고 시스템

---

## 📋 메모 및 참고사항

### 현재 프로젝트 상태
- 🎉 **4주차 핵심 완료 100%**: 컨텐츠-키 분리 아키텍처 완성!
- ✅ **LocalizationStore**: 키 자동 생성, 중복 감지, 일괄 수정 완료
- ✅ **실제 텍스트 기반 UI**: PropertyPanel, 노드 미리보기 완료
- ✅ **Export/Import v2.0**: LocalizationStore 포함, 레거시 호환성 지원
- ✅ **데이터 마이그레이션**: 자동 변환 및 검증 시스템 완료
- ✅ **QA 버그 수정**: TC-01~TC-06 주요 문제 해결 완료
- ✅ **키 편집 UI 개선**: 워크플로우 단순화 및 스마트 텍스트 관리 완료
- ✅ **QA 후 버그 수정**: 5개 주요 버그 모두 해결 완료!
- ✅ **QA 재테스트 후 추가 버그 수정**: 4개 추가 버그 모두 해결 완료!
- 🎯 **다음 단계**: 5주차 폴리싱 및 최종 QA 시작 준비 완료

### QA 결과 요약 (2024-12-19)
#### 발견된 문제들:
1. **중복 텍스트 감지 실패**: 가장 심각한 문제, 핵심 기능 오작동
2. **노드 생성 기본값**: 빈 문자열이 아닌 기본값 자동 설정
3. **키 편집 UI 동기화**: 편집 후 키 사용 개수 잘못 표시
4. **텍스트 변경 미반영**: 키 편집 모달에서 텍스트만 변경 시 UI 미반영
5. **버튼 표시 로직**: 변경사항 없을 때 버튼 숨김으로 사용성 저하

#### 수정 우선순위:
- 🔥 **최우선**: QA-BUG-01 (중복 텍스트 감지)
- 🔥 **높음**: QA-BUG-02 (노드 생성 기본값)
- 🟡 **중간**: QA-BUG-03, QA-BUG-04 (UI 동기화 문제)
- 🟢 **낮음**: QA-BUG-05 (UX 개선)

### 기술 스택 확정
- ✅ React + Vite + TypeScript
- ✅ React Flow (노드 시각화)
- ✅ Zustand (상태 관리)
- ✅ Tailwind CSS 4.x (스타일링) - 성공적으로 설정 완료
- ✅ Zod (스키마 검증)

### 주요 제약사항 (MVP)
- 템플릿당 100개 노드 제한
- TextDialogue, ChoiceDialogue만 생성 지원 (InputDialogue는 타입만)
- 순환 참조 허용 (루프 구조 지원)
- 서버 없는 SPA, localStorage만 사용
- **별도 키 관리 인터페이스는 MVP 제외** (G-01에서 구현)

### 핵심 설계 원칙
- **컨텐츠 작성과 키 관리의 완전 분리**: 기획자는 실제 텍스트에만 집중
- **실제 텍스트 우선**: 노드 미리보기, 편집 UI 모두 실제 텍스트 표시
- **백그라운드 키 관리**: LocalizationStore에서 key-value 매핑 자동 관리
- **의도적 키 관리**: 타이핑 중에는 키 생성 안함, 완료 시점에만 처리
- **단순한 키 편집**: 속성 패널(개별) vs 키 편집(일괄) 명확히 구분

### Acceptance Criteria 체크리스트
- [x] AC-01: 새 텍스트 노드 추가 → JSON 저장 동일 내용 존재 ✅ **완료**
- [ ] AC-02: 선택지별 "+" 버튼으로 해당 선택지의 nextNodeKey로 새 노드 자동 연결
- [x] AC-03: nextNodeKey 비어있으면 Export 버튼 비활성화 → Export 시점 검증으로 변경 ✅ **완료**
- [x] AC-04: 브라우저 새로고침 후 Canvas 레이아웃 복원 ✅ **완료**
- [x] AC-05: JSON/CSV Export → Import 후 데이터 무손실 ✅ **완료**
- [x] **AC-06**: 같은 텍스트 입력 → 키 재사용 제안, 키 수정 → 전체/분리 선택 (4주차 신규) ✅ **완료!** - QA 후 버그 수정으로 해결 