# Script Weaver - TODO List

## 🎯 MVP 목표
웹 기반 Dialogue Editor (프론트엔드-Only) - 컨텐츠-키 분리 아키텍처 기반
> **핵심**: 기획자는 실제 텍스트만 입력, 로컬라이징 키는 백그라운드 자동 관리

---

## ✅ 완료된 작업

### Phase 1 기본 시스템 구축 + 컨텐츠-키 분리 아키텍처 ✅
- React + Vite + TypeScript, Tailwind CSS 4.x, React Flow, Zustand 기반 웹 에디터 구축
- 노드 생성/편집/연결 시스템 구현
- 텍스트-키 분리 아키텍처 (LocalizationStore)
- 자동 키 생성 및 중복 처리
- JSON/CSV 데이터 관리

### Phase 2 사용성 개선 ✅
- **UX-01 중복 텍스트 처리 개선**: 모달 → 토스트 메시지로 변경, 전역 관리
- **노드 배치 기본 개선**: Y축 세로 배치 → X축 가로 배치 변경
- **자동 정렬 기능**: 선택된 노드 기준 자식 정렬, 전체 트리 정렬 기능 추가
- **성능 최적화**: 100개 노드 제한 구현, 생성 버튼 비활성화

---

## 📋 현재 상태

### 프로젝트 현황 🎉 **Phase 2 진행 중!**
- ✅ **Phase 1 완료 100%**: 컨텐츠-키 분리 아키텍처 기반 MVP 완성
- 🟡 **Phase 2 진행 중**: UX 개선 완성, 노드 배치 고도화 진행 중, 핵심 편집 기능 개선 진행 중
- ✅ **LocalizationStore**: 키 자동 생성, 중복 감지, 일괄 수정, 전역 토스트 관리
- ✅ **실제 텍스트 기반 UI**: PropertyPanel, 노드 미리보기, 토스트 알림 완료
- ✅ **레이아웃 엔진 시스템**: 3단계 파이프라인, 앵커 오프셋, 순환 참조 감지 완성

### 현재 배포 상태 📊 **(안정적 운영 중)**
- ✅ **기능 완성도**: 87% - 모든 MVP + Phase 2 UX 개선 완료, 노드 배치 시스템 + Undo/Redo 시스템 + 비동기 작업 관리 완성
- ✅ **품질 안정성**: 99% - 모든 AC 항목, QA, 회귀 테스트 + 레이아웃 시스템 + TC-30 상태 충돌 방지 검증
- ✅ **사용자 경험**: 96% - 전역 단축키, UI 간소화, 스마트 정렬, 실시간 상태 표시로 전문 도구 수준 달성 🎉
- ✅ **성능 최적화**: 94% - 100개 노드 제한, 즉시 배치, 순환 참조 방어, 작업 간 상호 차단
- ✅ **GitHub Pages 배포**: 안정적 운영 중 🌟
- 🎯 **다음 단계**: Phase 2 완성 - 핵심 편집 기능 개선

---

## 📋 예정된 작업

### **Phase 2: 사용성 개선** 🟡 **진행 중 (85% 완료)**

#### 완료된 핵심 개선사항 ✅
- [x] **UX-01 중복 텍스트 처리 개선**: 모달 → 토스트, 전역 관리 ✅
- [x] **노드 배치 기본 개선**: Y축 세로 → X축 가로 배치 변경 ✅  
- [x] **자동 정렬 기능**: 선택된/전체 노드 트리 정렬 시스템 ✅
- [x] **성능 최적화**: 100개 노드 제한, 생성 버튼 제어 ✅
- [x] **전역 단축키 시스템**: 전문 편집 도구 수준의 키보드 워크플로우 완성 ✅
- [x] **UI 간소화**: 좌측 패널 70% 공간 절약, 핵심 기능 중심 재구성 ✅

#### 노드 배치 및 정렬 시스템 개선 🎯 **높은 우선순위** 🟡 **진행 중**
- [x] **핸들 클릭 노드 생성 위치 개선** ✅ **완료 (2025-06-14)**
  - 해결: 부모 노드 우측 50px 간격, 중앙 정렬 배치 구현
  - 실제 DOM 크기 측정 기반 정확한 위치 계산
  - TextNode/ChoiceNode 모두 통일된 중앙 정렬 로직 적용
- [x] **🚀 레이아웃 엔진 시스템 구축** ✅ **완료 (2025-06-14)**
  - **문제 해결**: 노드 위치 계산 오류 → 종합적인 레이아웃 시스템 구축
  - **핵심 구현**:
    - `src/utils/layoutEngine.ts`: 완전한 레이아웃 시스템 (463줄)
    - `LayoutEngine` 인터페이스 + `DagreLayoutEngine` 구현
    - `NodeMeasurementSystem`: ResizeObserver 기반 실제 크기 측정
    - `LayoutSystem`: 3단계 파이프라인 (수집→측정→배치)
  - **3가지 정렬 기능 완성**:
    - 전체 캔버스 정렬: 그래프 구조 분석 기반 올바른 루트 찾기
    - 선택 노드 자식만 정렬 (`depth=1`): 앵커 노드 고정
    - 선택 노드 후손 전체 정렬 (`depth=∞`): 앵커 노드 고정
  - **고급 기능**:
    - 앵커 노드 오프셋: 선택된 노드 위치 고정
    - 순환 참조 감지: 무한루프 방지 시스템
    - 즉시 배치: CSS transition 제거로 성능 최적화
  - **패키지 추가**: `dagre` + `@types/dagre`
  - **UI 통합**: App.tsx "스마트 정렬 🚀" 섹션 완성
- [ ] **레이아웃 엔진 개선 사항** - 테스트 중 발견된 추가 개선점들
  - **다중 그래프 정렬 개선**: 독립적인 여러 그래프 존재 시 시작 노드들을 좌측에 세로 일렬 배치
  - **기존 정렬 버튼 정리**: 기존 정렬 버튼 제거, 로직만 필요시 재활용
  - **다중 부모 노드 정렬**: DAG 구조에서 공통 자식을 가진 부모들의 연쇄 정렬 개선
    - 예시: 선택지 분기 후 합류하는 마무리 대사 노드의 정렬 최적화
  - **노드 스냅 기능**: 드래그 시 근처 노드의 상하좌우 및 중앙에 자동 정렬 가이드
    - 구현: 항상 활성화, 실시간 스냅 가이드라인 표시

#### 핵심 편집 기능 개선 ⭐ **높은 우선순위**
- [x] **다중 선택 및 조작** ✅ - Ctrl+Click, 드래그 선택, 일괄 삭제/이동
- [x] **핸들 클릭으로 후속 노드 생성** ✅
- [x] **화자 자동 입력 기능** - 핸들 클릭 노드 생성 시 부모 화자 정보 복사 ✅
- [x] **노드 생성 로직 리팩터링** - 중복 코드 제거 및 일관된 기본값 적용 ✅ **완료 (2025-06-14)**
  - 해결: createBaseTextDialogue, createBaseChoiceDialogue, createNodeWrapper 공통 함수 추가
  - 개선: 모든 노드 생성 방식에서 일관된 기본값(speed: NORMAL) 적용
  - 효과: 약 100줄 이상의 중복 코드 제거, 속성 누락 방지, 유지보수성 향상
- [x] **선택지 노드 기본 구조 개선** - 생성 시 빈 선택지 2개 자동 제공 ✅ **완료 (2025-06-14)**
  - 해결: getDefaultChoices() 함수로 표준화된 기본 선택지 구조 제공
  - UX 향상: 사용자가 즉시 편집 가능한 빈 선택지 슬롯 제공
- [x] **Undo/Redo 시스템 확장** ✅ **완료 (2025-06-15 13:42)**
  - **해결**: EC-09 이슈 완전 해결 - 누락된 액션들의 히스토리 추가 완성
  - **핵심 개선사항**:
    - `LocalizationStore 포함`: 키-값 매핑도 히스토리에 포함하여 텍스트 편집 되돌리기 완벽 지원
    - `텍스트 편집 히스토리`: blur/enter 시점에 자동으로 히스토리 추가, 변경 감지로 불필요한 엔트리 방지
    - `연속 드래그 감지`: 포토샵 스타일로 1초 이내 같은 노드 드래그는 하나의 액션으로 묶기
    - `노드 연결 히스토리`: 드래그 연결 생성 시 선택지 정보 포함하여 히스토리 추가
    - **🎯 비동기 작업 중 Undo/Redo 차단**: TC-30 문제 해결 - 복합 액션/정렬 중 Ctrl+Z/Ctrl+Y 차단으로 상태 충돌 방지
  - **구현 완료 기능**:
    - HistoryState에 localizationData 포함
    - PropertyPanel의 commitSpeakerText/commitContentText/commitChoiceText에 히스토리 추가
    - moveNode에서 연속 드래그 감지 로직 (1초 임계값)
    - Canvas handleConnect에서 연결 생성 히스토리
    - 변경사항 감지로 무의미한 히스토리 엔트리 방지
    - **AsyncOperationManager**: 비동기 작업 관리자 (src/store/asyncOperationManager.ts)
    - **동적 상태바**: 작업 진행 상태 실시간 표시 (idle/working/success/error)
    - **작업 간 상호 차단**: 정렬 중 복합 액션, 복합 액션 중 정렬 등 동시 실행 방지
    - **internal 플래그**: 복합 액션 내부 정렬 허용으로 노드 생성 시 정렬 정상 작동
  - **기술적 세부사항**:
    - 히스토리 스택 50개 유지
    - pushToHistoryWithTextEdit 메서드 추가
    - lastDraggedNodeKey, lastDragActionTime 상태 추가
    - Import 시 히스토리 초기화는 기존대로 유지
    - AsyncOperationManager 싱글톤 패턴으로 전역 작업 상태 관리
    - App.tsx 상태바 영역에 실시간 작업 상태 표시 (애니메이션 포함)
    - 정렬 함수들에 internal 매개변수 추가로 복합 액션 내부 호출 구분
- [ ] **노드 복사/붙여넣기 고도화** - 다중 노드 복사 시 내부 연결 관계 유지
  - 현재 문제: 여러 노드 복사 시 노드간 연결이 복사되지 않음
  - 개선 목표: 선택된 노드들의 내부 연결 관계를 분석하여 함께 복사
  - 구현 방향: 클립보드에 노드 + 엣지 정보 저장, 붙여넣기 시 관계 복원
- [ ] **노드 타입 변환 기능** - PropertyPanel에서 TextNode ↔ ChoiceNode 변환
  - 구현 목표: 기존 텍스트 유지하면서 노드 타입만 변경
  - 변환 로직: TextNode → ChoiceNode (기본 선택지 1개), ChoiceNode → TextNode (첫 번째 선택지를 다음 노드로)

#### 데이터 관리 및 기타 개선 🔧 **중요**
- [ ] **노드 삭제 시 키 정리** - 삭제된 노드의 LocalizationStore 키 자동 제거
  - 현재 문제: 노드 삭제 시 해당 키가 LocalizationStore에 남아있음
  - 구현 방향: deleteNode 함수에서 관련 키들도 함께 정리
  - undo/redo 기능 고려: undo/redo 할 때 localizationStore 데이터 삭제/복구 잘 이뤄지는지 체크 필요
- [ ] **키 편집 후 사용 개수 업데이트** - 키 수정 시 UI 갱신 문제
  - 현재 문제: 키 편집 후 "1개 사용 중"이 "0개"로 잘못 표시
  - 구현 방향: 키 편집 완료 후 PropertyPanel 상태 강제 갱신
- [ ] **고아 키 정리 기능** - 사용되지 않는 키 자동 감지 및 일괄 삭제
- [ ] **localStorage 관리 도구** - 저장 공간 사용량 표시, 수동 정리 기능
- [ ] **타입별 중복 검사 강화** - 화자/대사/선택지별 독립적 중복 감지

### Phase 3: 폴리싱 🟢 **선택적**
- [ ] **시각적 개선**: 애니메이션 및 트랜지션 추가
  - 노드 생성/삭제 애니메이션
  - 연결 생성 시 시각적 피드백
  - 부드러운 트랜지션 효과
- [ ] **성능 튜닝**: 빌드 최적화 및 번들 크기 최적화
  - Vite 빌드 설정 최적화
  - 번들 크기 분석 및 최적화
  - 로딩 성능 개선

#### UI/UX 세부 개선 ✨ **사용자 경험**
- [ ] **삭제 확인 다이얼로그 제거** - Undo 기능으로 confirm 없이 즉시 삭제
  - 개선 목표: 빠른 편집 워크플로우, 실수 시 Ctrl+Z로 복구
- [ ] **토스트 메시지 위치 변경** - 중앙 하단 → 중앙 상단으로 이동
  - UX 개선: 하단 툴바와 겹치지 않도록 상단 배치
- [ ] **노드 우클릭 메뉴** - 컨텍스트 메뉴로 빠른 액션 제공
  - 메뉴 항목: 복사, 삭제, 복제, 타입 변환 등
- [ ] **노드 ID 미리보기 제거** - 기획자 친화적 UI로 ID 숨김 처리
- [ ] **엣지 제목 숨김** - 연결선 레이블 시각적 정리
- [ ] **모달 딤 조절 기능** - 배경 어둡기 사용자 설정
- [ ] **장면 시작 노드 표시** - 시나리오 시작점 시각적 구분
- [ ] **기본 접근성**: 키보드 탐색, 반응형 디자인
  - Tab/Enter 키보드 탐색 지원
  - 모바일/태블릿 반응형 레이아웃
  - ARIA 라벨 및 접근성 개선

#### 조건부 기능 확장 🔍 **검토 필요**
- [ ] **InputDialogue 노드 지원** - 사용자 입력 노드 생성 및 런타임 속성
- [ ] **선택지 전용 노드** - 대사 없이 선택지만 있는 노드 타입
- [ ] **명시적 종료 노드** - 시나리오 종료점 명확화 (vs 현재 빈 nextNodeKey 방식)

---

## 🔮 향후 확장 계획 (Post-MVP)

### 우선순위 기능 (중요도 순)
1. **G-01: 로컬라이징 전용 탭** - key-value 매핑 직접 관리 (사용자 요청 높음)
2. **G-02: 플로우 시뮬레이터** - 플레이 모드 (기획자 검증 도구)
3. **G-06: InputDialogue 노드** - 사용자 입력 노드 생성 및 런타임 속성 지원 (기능 완성도)
4. **G-03: 콜백 키 CRUD 페이지** + 검색 (개발자 도구)

### 장기 계획
5. **G-04: 커스텀 메타데이터** - 감정, 카메라, SFX 확장 (확장성)
6. **G-05: 버전 관리** - Git, 다중 사용자 협업 (협업 도구)
7. **G-07: 히스토리 관리** - 작업 히스토리 diff 방식 기반으로 되돌리기/다시실행
  - 장기 계획: 액션 기반 증분 저장으로 메모리 효율성 개선
  - 전환 시점: 대용량 프로젝트 지원 시 (노드 1000개+) 또는 실시간 협업 기능 추가 시
  - 기술적 고려사항: 현재 인터페이스 유지하여 호출부 코드 변경 없이 내부 구현만 교체 예정

### 레이아웃 엔진 로드맵 🗺️ **장기 계획 (2025-06-14 수립)**
1. **✅ ① 내부 MVP (Dagre)** - 3단계 해결 방식 + 3가지 정렬 기능 구현 **완료!**
2. **② 레이아웃 엔진 추상화** - 인터페이스 분리, 플러그인 아키텍처 구축 *(이미 구현됨)*
3. **③ 플러그인/웹워커화** - 백그라운드 처리, 성능 최적화
4. **④ ELK Pro 기능** - 복잡한 그래프, 고급 레이아웃 알고리즘
5. **⑤ 실시간 협업·권한 관리** - 다중 사용자 동시 편집
6. **⑥ 상품화 (Free/Pro 플랜)** - 기능별 티어링, 수익화 모델

---

## 📋 기술 정보 요약

### 아키텍처 핵심
- **컨텐츠-키 분리**: 실제 텍스트(기획자) ↔ 로컬라이징 키(개발자) 완전 분리
- **LocalizationStore**: 백그라운드 key-value 매핑 저장소
- **의도적 키 관리**: 타이핑 중 키 생성 안함, 완료 시점에만 처리
- **숫자 ID 기반 키**: `npc_1`, `line_1`, `choice_1` 형태로 충돌 방지

### 주요 제약사항 (MVP)
- 템플릿당 100개 노드 제한
- TextDialogue, ChoiceDialogue만 생성 지원 (InputDialogue는 타입만)
- 서버 없는 SPA, localStorage만 사용
- MVP에서는 순환 참조 허용 (루프 구조 지원)

### Acceptance Criteria 체크리스트 ✅ **QA 검증 완료**
- [x] AC-01: 새 텍스트 노드 추가 → JSON 저장 및 키 매핑 ✅ **QA 통과**
- [x] AC-02: 선택지별 "+" 버튼으로 해당 선택지의 nextNodeKey로 새 노드 자동 연결 ✅ **QA 통과**
- [x] AC-03: nextNodeKey 비어있으면 Export 버튼 비활성화 및 검증 ✅ **QA 통과**
- [x] AC-04: 브라우저 새로고침 후 Canvas 레이아웃 복원 ✅ **QA 통과**
- [x] AC-05: JSON/CSV Export → Import 후 데이터 무손실 ✅ **QA 통과**
- [x] AC-06: 같은 텍스트 입력 → 키 재사용 제안, 키 수정 → 일괄 변경 선택 ✅ **QA 통과**

---

## 📋 메모

### 개발 우선순위
1. ✅ **완료**: MVP + Phase 2 노드 배치 시스템 (토스트, 배치, 레이아웃 엔진, 성능) 🎉
2. **현재**: Phase 2 완성 - 핵심 편집 기능 개선 (Undo/Redo, 복사/붙여넣기, 노드 변환) 🚀
3. **향후**: Phase 3 폴리싱 → Post-MVP 확장 기능

### 주요 레퍼런스
- **PRD**: `document/prd.md` - 전체 프로젝트 사양 및 기술 스택
- **기술 스택**: React + Vite + TypeScript, React Flow, Zustand, Tailwind CSS 4.x, Zod 

### 임시 메모
- "전체 캔버스 정렬"
  - 버튼 클릭 시, 루트 노드 하나에 대해서만 정렬되는 문제 있음
  - 빈 캔버스 정렬 시 아무런 반응이 없어야 하는데, 정렬이 완료되었다는 토스트 메세지가 팝업됨. (정렬할 노드가 없다고 띄우거나, 그냥 버튼 입력 무시하는 것으로 변경)
- 노드 생성 시 위치 기준 모호함
- JSON 저장/불러오기 할 때 localizationStore 데이터 손실 문제 의심됨
- undo/redo
  - 히스토리에 액션 명만 토스트 메세지로 띄워주면 될것 같음 (노드 아이디나 노드 개수는 굳이? 개수는 괜찮나?)
  - 복합액션은 꼭 복합액션이라고 써야하나?
- 콘솔 경고 에러메세지 코드화 필요

다음 작업 목록
* 콘솔로그 지우기, warn만 남기기
* 리팩토링, 모듈화, 중복 제거